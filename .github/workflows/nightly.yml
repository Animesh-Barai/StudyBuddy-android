name: Nightly releases

# on:
#   schedule:
#     cron: "0 0 * * *" # Executes every day at 12 midnight UTC
on: watch # TODO: Remove this once workflow has been tested

jobs:
  deploy:

    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v1
    - name: Setup Java
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Install GPG2
      run: sudo apt-get install gnupg2
    - name: Install Homebrew
      run: |
        sh -c "$(curl -fsSL https://raw.githubusercontent.com/Linuxbrew/install/master/install.sh)"
        test -d ~/.linuxbrew && eval $(~/.linuxbrew/bin/brew shellenv)
        test -d /home/linuxbrew/.linuxbrew && eval $(/home/linuxbrew/.linuxbrew/bin/brew shellenv)
        test -r ~/.bash_profile && echo "eval \$($(brew --prefix)/bin/brew shellenv)" >>~/.bash_profile
        echo "eval \$($(brew --prefix)/bin/brew shellenv)" >>~/.profile
        sudo apt-get install build-essential curl file git
        echo "Current path:"
        echo $PATH
    - name: Install Homebrew dependencies
      run: |
        source ~/.profile
        brew bundle
    - name: Decrypt keystore
      run: |
        source ~/.profile
        git-secret reveal -p ${{ secrets.GIT_SECRET_PASSPHRASE }}
      env:
        SECRETS_GPG_COMMAND: gpg2
    - name: Build app
      run: ./gradlew :app:assembleNightly # APK is available at app/build/outputs/apk/nightly/app-nightly.apk
    - name: Create nightly tag
      run: |
        recent_tag=$(git describe --tags $(git ls-remote --tags -q | awk '{print $2}' | sed -e "s/refs\/tags\///" \
        | grep -o 'v[0-9.]*[^-NIGHTLY]' | sort -u | tail -1))
        tag_name="$recent_tag-NIGHTLY-$(date +'%Y-%m-%d-%H%M%S')"
        if git rev-parse "$tag_name" >/dev/null 2>&1
        then
          echo "##[debug]Skipping creation of nightly tag as nightly tag already exists."
        else
          git tag $tag_name
          echo "Pushing tag to origin..."
          git push origin $tag_name
        fi
    - name: Release
      uses: docker://softprops/action-gh-release
      with:
        files: app/build/outputs/apk/nightly/app-nightly.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
